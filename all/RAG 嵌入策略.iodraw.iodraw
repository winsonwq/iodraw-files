<mxGraphModel dx="832" dy="624" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0"><root><mxCell id="WIyWlLk6GJQsqaUBKTNV-0"/><mxCell id="WIyWlLk6GJQsqaUBKTNV-1" parent="WIyWlLk6GJQsqaUBKTNV-0"/><mxCell id="necO2ApstZsxha5vqZVX-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="necO2ApstZsxha5vqZVX-0" target="necO2ApstZsxha5vqZVX-8"><mxGeometry relative="1" as="geometry"><mxPoint x="414.9999999999999" y="244" as="targetPoint"/></mxGeometry></mxCell><mxCell id="necO2ApstZsxha5vqZVX-0" value="" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="405" y="114" width="20" height="20" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="necO2ApstZsxha5vqZVX-8" target="necO2ApstZsxha5vqZVX-12"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-14" value="是" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="necO2ApstZsxha5vqZVX-13"><mxGeometry x="-0.0983" y="-1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry></mxCell><mxCell id="necO2ApstZsxha5vqZVX-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="necO2ApstZsxha5vqZVX-8" target="necO2ApstZsxha5vqZVX-17"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-19" value="否" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="necO2ApstZsxha5vqZVX-18"><mxGeometry x="-0.0589" y="-3" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry></mxCell><mxCell id="necO2ApstZsxha5vqZVX-8" value="是否有用户嵌入？&lt;br&gt;有指定文档&lt;br&gt;或者标签" style="rhombus;whiteSpace=wrap;html=1;align=center;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="335" y="244" width="160" height="150" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-11" value="" style="group" vertex="1" connectable="0" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="435" y="144" width="190" height="90" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-6" value="&lt;b&gt;嵌入选项 EmbeddingObjects&lt;/b&gt;&lt;br&gt;1. 指定了文档&lt;br&gt;2. 指定了标签&lt;br&gt;3. 范围没有指定" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="necO2ApstZsxha5vqZVX-11"><mxGeometry width="190" height="60" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-7" value="&lt;b&gt;提交提示词 prompt&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="necO2ApstZsxha5vqZVX-11"><mxGeometry y="70" width="190" height="20" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="necO2ApstZsxha5vqZVX-12" target="necO2ApstZsxha5vqZVX-15"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-12" value="确定嵌入的文档有哪些&lt;br&gt;1. 指定了文档&lt;br&gt;2. 通过 tag 检索出来的文档对象&lt;br&gt;（通过 tag 标签查找的文档可能导致上下文过大）" style="rounded=0;whiteSpace=wrap;html=1;align=center;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="700" y="277" width="310" height="84.37" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-24" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="necO2ApstZsxha5vqZVX-15" target="necO2ApstZsxha5vqZVX-22"><mxGeometry relative="1" as="geometry"><Array as="points"><mxPoint x="855" y="630"/><mxPoint x="415" y="630"/></Array></mxGeometry></mxCell><mxCell id="necO2ApstZsxha5vqZVX-15" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;配合提示词&amp;nbsp;&lt;/span&gt;&lt;b&gt;EMBEDDING_STRAGEGY_JSON&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;让 AI 来分析嵌入选项：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;{&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;&amp;nbsp; &amp;nbsp; objectName1: false,&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;&amp;nbsp; &amp;nbsp; objectName2: true&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;false 代表不完全嵌入&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;true 代表完全嵌入&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="700" y="424.19" width="310" height="155.81" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="necO2ApstZsxha5vqZVX-17" target="necO2ApstZsxha5vqZVX-22"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-17" value="没有指定嵌入的内容&lt;br&gt;配合提示词&amp;nbsp;&lt;b&gt;NORMAL_STRATEGY_JSON &lt;br&gt;&lt;/b&gt;让 AI 来判断针对提示词 prompt 是否需要做全局搜索&lt;br&gt;{ needSearch: true } 或者 false" style="rounded=0;whiteSpace=wrap;html=1;align=center;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="260" y="499.63" width="310" height="84.37" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-22" value="根据 needSearch 或者嵌入对象进行向量查询&lt;br&gt;&lt;b&gt;getObjectEmbeddingsByStrategy 函数&lt;/b&gt;&lt;br&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;ol&gt;&lt;li&gt;&lt;span&gt;嵌入对象的情况，每个嵌入文件进行向量查询&lt;/span&gt;&lt;/li&gt;&lt;ol&gt;&lt;li&gt;&lt;span&gt;如果 objectName: true 代表整个文件内容都嵌入（往往在分析总结的问题上需要）&lt;/span&gt;&lt;/li&gt;&lt;li&gt;&lt;span&gt;如果 objectName: false 代表部分嵌入，那么根据提示词搜索相关性（往往在问是否有，是否存在的问题上）&lt;/span&gt;&lt;/li&gt;&lt;ol&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;li&gt;needSearch: true 的情况，全局都会通过 prompt 查找向量进行注入; 如果 needSearch: false 什么都不会嵌入（如果提示词中“不检索知识库”可以触发）&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="260" y="690" width="310" height="210" as="geometry"/></mxCell><mxCell id="necO2ApstZsxha5vqZVX-25" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;b&gt;AI 统一提交问答&amp;nbsp;&lt;/b&gt;&lt;b&gt;CHAT_PROMPT&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;ol&gt;&lt;li&gt;systemMessage&lt;/li&gt;&lt;li&gt;获取到 embeddingContent 嵌入的内容&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#ff0000&quot;&gt;（如果超过 50K 会自动截取，导致上下文不完整的问题）&lt;/font&gt;&lt;/b&gt;&lt;/li&gt;&lt;li&gt;获取 chatHistory&lt;br&gt;&lt;b&gt;&lt;font color=&quot;#ff0000&quot;&gt;（多次长文本聊天会导致超过 128K 上下文）&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;font&gt;提示词 prompt&lt;/font&gt;&lt;/li&gt;&lt;/ol&gt;&lt;div style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1"><mxGeometry x="620" y="690" width="310" height="170" as="geometry"/></mxCell></root></mxGraphModel>